apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-chart.configMapName" . }}
  namespace: {{ include "redis-chart.namespace" . }}
  labels:
    {{- include "redis-chart.labels" . | nindent 4 }}
    app: {{ .Values.global.appName }}
    component: config
    app.kubernetes.io/component: config
data:
  # Redis Master ì„¤ì •
  redis-master.conf: |
    # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
    bind {{ .Values.config.bind }}
    port {{ .Values.config.port }}
    protected-mode {{ .Values.config.protectedMode }}
    
    # ë©”ëª¨ë¦¬ ì„¤ì •
    maxmemory {{ .Values.config.maxmemory }}
    maxmemory-policy {{ .Values.config.maxmemoryPolicy }}
    
    # ì§€ì†ì„± ì„¤ì • (MasterëŠ” AOF ì‚¬ìš©)
    appendonly {{ .Values.config.appendonly }}
    appendfsync {{ .Values.config.appendfsync }}
    auto-aof-rewrite-percentage {{ .Values.config.autoAofRewritePercentage }}
    auto-aof-rewrite-min-size {{ .Values.config.autoAofRewriteMinSize }}
    
    # RDB ë°±ì—… ì„¤ì •
{{- range .Values.config.save }}
    save {{ . }}
{{- end }}
    
    # ë¡œê·¸ ì„¤ì •
    loglevel {{ .Values.config.loglevel }}
    
    # í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
    tcp-keepalive {{ .Values.config.tcpKeepalive }}
    timeout {{ .Values.config.timeout }}
    
    # ë³µì œ ì„¤ì •
    replica-serve-stale-data yes
    replica-read-only yes
    
    # ë³´ì•ˆ ì„¤ì •ì€ Secretì—ì„œ ì£¼ì…

  # Redis Slave ì„¤ì •
  redis-slave.conf: |
    # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
    bind {{ .Values.config.bind }}
    port {{ .Values.config.port }}
    protected-mode {{ .Values.config.protectedMode }}
    
    # ë©”ëª¨ë¦¬ ì„¤ì •
    maxmemory {{ .Values.config.maxmemory }}
    maxmemory-policy {{ .Values.config.maxmemoryPolicy }}
    
    # ì§€ì†ì„± ì„¤ì • (SlaveëŠ” AOF ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ ìµœì í™”)
    appendonly no
    
    # RDB ë°±ì—… ì„¤ì • (SlaveëŠ” ë°±ì—… ì£¼ê¸° ê¸¸ê²Œ)
    save 1800 1
    save 600 10
    save 300 100
    
    # ë¡œê·¸ ì„¤ì •
    loglevel {{ .Values.config.loglevel }}
    
    # í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
    tcp-keepalive {{ .Values.config.tcpKeepalive }}
    timeout {{ .Values.config.timeout }}
    
    # ë³µì œ ì„¤ì •
    replica-serve-stale-data yes
    replica-read-only yes
    replica-priority 100
    
    # Master ì—°ê²° ì„¤ì •ì€ init-slave.shì—ì„œ ì²˜ë¦¬

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-chart.scriptsConfigMapName" . }}
  namespace: {{ include "redis-chart.namespace" . }}
  labels:
    {{- include "redis-chart.labels" . | nindent 4 }}
    app: {{ .Values.global.appName }}
    component: scripts
    app.kubernetes.io/component: scripts
data:
  # Master ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
  init-master.sh: |
    #!/bin/bash
    set -e
    
    echo "ğŸš€ Redis Master ì´ˆê¸°í™” ì‹œì‘..."
    
    # ì„¤ì • íŒŒì¼ ë³µì‚¬
    cp /config/redis-master.conf /data/redis.conf
    
    # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (Secretì—ì„œ ì£¼ì…)
    if [ ! -z "$REDIS_PASSWORD" ]; then
        echo "requirepass $REDIS_PASSWORD" >> /data/redis.conf
        echo "masterauth $REDIS_PASSWORD" >> /data/redis.conf
    fi
    
    echo "âœ… Redis Master ì´ˆê¸°í™” ì™„ë£Œ"
    
    # Redis ì„œë²„ ì‹œì‘
    exec redis-server /data/redis.conf

  # Slave ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
  init-slave.sh: |
    #!/bin/bash
    set -e
    
    echo "ğŸš€ Redis Slave ì´ˆê¸°í™” ì‹œì‘..."
    
    # ì„¤ì • íŒŒì¼ ë³µì‚¬
    cp /config/redis-slave.conf /data/redis.conf
    
    # Master ì—°ê²° ì„¤ì •
    MASTER_HOST="{{ include "redis-chart.masterFQDN" . }}"
    echo "replicaof $MASTER_HOST {{ .Values.config.port }}" >> /data/redis.conf
    
    # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (Secretì—ì„œ ì£¼ì…)
    if [ ! -z "$REDIS_PASSWORD" ]; then
        echo "requirepass $REDIS_PASSWORD" >> /data/redis.conf
        echo "masterauth $REDIS_PASSWORD" >> /data/redis.conf
    fi
    
    echo "âœ… Redis Slave ì´ˆê¸°í™” ì™„ë£Œ"
    
    # Master ì—°ê²° ëŒ€ê¸°
    echo "â³ Master ì—°ê²° ëŒ€ê¸° ì¤‘..."
    until redis-cli -h $MASTER_HOST -p {{ .Values.config.port }}{{ if .Values.auth.enabled }} -a $REDIS_PASSWORD{{ end }} ping; do
        echo "Master ì—°ê²° ëŒ€ê¸° ì¤‘... (5ì´ˆ í›„ ì¬ì‹œë„)"
        sleep 5
    done
    
    echo "âœ… Master ì—°ê²° í™•ì¸ë¨"
    
    # Redis ì„œë²„ ì‹œì‘
    exec redis-server /data/redis.conf

  # í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸
  health-check.sh: |
    #!/bin/bash
    
    # Redis ì—°ê²° í…ŒìŠ¤íŠ¸
    if [ ! -z "$REDIS_PASSWORD" ]; then
        redis-cli -a "$REDIS_PASSWORD" ping
    else
        redis-cli ping
    fi

  # ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
  backup.sh: |
    #!/bin/bash
    set -e
    
    BACKUP_DIR="/backup"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    
    echo "ğŸ”„ Redis ë°±ì—… ì‹œì‘: $TIMESTAMP"
    
    # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p $BACKUP_DIR
    
    # RDB ë°±ì—…
    if [ ! -z "$REDIS_PASSWORD" ]; then
        redis-cli -a "$REDIS_PASSWORD" BGSAVE
    else
        redis-cli BGSAVE
    fi
    
    # ë°±ì—… ì™„ë£Œ ëŒ€ê¸°
    while [ $(redis-cli -a "$REDIS_PASSWORD" LASTSAVE) -eq $(redis-cli -a "$REDIS_PASSWORD" LASTSAVE) ]; do
        sleep 1
    done
    
    # ë°±ì—… íŒŒì¼ ë³µì‚¬
    cp /data/dump.rdb $BACKUP_DIR/dump_$TIMESTAMP.rdb
    
    # AOF ë°±ì—… (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
    if [ -f /data/appendonly.aof ]; then
        cp /data/appendonly.aof $BACKUP_DIR/appendonly_$TIMESTAMP.aof
    fi
    
    echo "âœ… Redis ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
    
    # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒ)
    find $BACKUP_DIR -name "*.rdb" -mtime +7 -delete
    find $BACKUP_DIR -name "*.aof" -mtime +7 -delete

